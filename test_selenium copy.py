from playwright.sync_api import sync_playwright

# --- Helpers g√©n√©riques corrig√©s ---
def select_dropdown(page, label, value):
    input_box = page.locator(f"label:has-text('{label}') + div input[placeholder]").first
    input_box.click()
    page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    page.locator("div.v-overlay-container .v-list-item-title", has_text=value).first.click()
    print(f"‚úÖ {label} s√©lectionn√© : {value}")

def fill_input(page, label, value):
    page.wait_for_selector(f"label:has-text('{label}')")
    input_box = page.locator(f"label:has-text('{label}')").locator("xpath=..").locator("input")
    input_box.fill(str(value))
    print(f"‚úÖ {label} rempli : {value}")

def safe_fill_input(el, value: str):
    try: el.scroll_into_view_if_needed()
    except Exception: pass
    try:
        el.fill(value)
        el.page.wait_for_timeout(120)
        return
    except Exception: pass
    try:
        el.click()
        el.page.keyboard.press("Control+A")
        el.type(value, delay=20)
    except Exception: pass
    el.page.wait_for_timeout(120)

def get_active_panel(page):
    pnl = page.locator('[role="tabpanel"]:visible, .v-window-item--active').first
    return pnl if pnl.count() else None

def _scope(panel_or_none, page, selector: str):
    if panel_or_none:
        nodes = panel_or_none.locator(selector)
        if nodes.count():
            return nodes
    return page.locator(selector)

def save_current_section(page, panel=None, label="section"):
    """Clique 'Enregistrer' de fa√ßon robuste (panel d'abord), g√®re overlays et attend networkidle."""
    for attempt in range(3):
        try:
            btns = _scope(panel, page, "button:has-text('Enregistrer')")
            btn = btns.filter(has_not=page.locator('[aria-hidden="true"]')).last
            if not btn.count():
                btn = page.locator("button:has-text('Enregistrer')").last
            btn.scroll_into_view_if_needed()
            btn.click(force=True)
            page.wait_for_load_state("networkidle")
            page.wait_for_timeout(500)
            print(f"üíæ Enregistr√© ({label})")
            return True
        except Exception:
            # si une liste/overlay intercepte ‚Üí ESC puis retry
            try:
                if page.locator("div.v-overlay-container .v-list, div.v-overlay-container .v-overlay").filter(has_text="").first.is_visible():
                    page.keyboard.press("Escape")
                    page.wait_for_timeout(200)
            except Exception:
                pass
            page.wait_for_timeout(400)
    print(f"‚ö†Ô∏è Impossible d'enregistrer ({label}), on continue quand m√™me.")
    return False

# --- Ajout cat√©gorie de donn√©es ---
def ajouter_categorie_donnees(page, donnee):
    print(f"‚û°Ô∏è Ajout en cours (Cat√©gorie de donn√©es) : {donnee['categorie_index']} - {donnee['type']}")
    page.get_by_role("button", name="Ajouter").first.click()
    page.wait_for_timeout(1000)
    page.locator("label:has-text('Cat√©gorie des donn√©es') + div input").click()
    page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    page.locator("div.v-overlay-container .v-list-item-title").nth(donnee["categorie_index"]).click()
    print(f"‚úÖ Cat√©gorie s√©lectionn√©e (index {donnee['categorie_index']})")
    select_dropdown(page, "Type des donn√©es", donnee["type"])
    select_dropdown(page, "Origine de la donn√©e", donnee["origine"])
    select_dropdown(page, "Utilis√©(s) pour la finalit√© du traitement", donnee["utilise"])
    select_dropdown(page, "Source de donn√©es", donnee["source"])
    if donnee["duree_type"] != "Limit√©e":
        select_dropdown(page, "Dur√©e de conservation", donnee["duree_type"])
    else:
        print("‚ÑπÔ∏è Dur√©e de conservation par d√©faut = Limit√©e (aucune action n√©cessaire)")
    fill_input(page, "Pr√©ciser la dur√©e (mois)", donnee["duree"])
    fill_input(page, "√âl√©ment d√©clencheur", donnee["declencheur"])
    save_current_section(page, label="Cat√©gorie de donn√©es")
    print("‚úÖ Cat√©gorie de donn√©es ajout√©e avec succ√®s")

# --- Finalit√© ---
def remplir_finalite(page, finalite_fr, finalite_ar):
    print("‚û°Ô∏è Remplissage de la section Finalit√©")
    menu_item = page.get_by_text("Finalit√©", exact=True)
    menu_item.scroll_into_view_if_needed()
    menu_item.click(force=True)
    page.wait_for_timeout(1500)
    textarea_fr = page.locator("label:has-text('Finalit√© (but) du traitement')").locator("xpath=..").locator("textarea")
    textarea_fr.fill(finalite_fr)
    print(f"‚úÖ Finalit√© FR remplie : {finalite_fr}")
    textarea_ar = page.locator("label:has-text('ÿßŸÑÿ∫ÿßŸäÿ© (ÿßŸÑŸáÿØŸÅ) ŸÖŸÜ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©')").locator("xpath=..").locator("textarea")
    textarea_ar.fill(finalite_ar)
    print(f"‚úÖ Finalit√© AR remplie : {finalite_ar}")
    save_current_section(page, label="Finalit√©")
    print("‚úÖ Section Finalit√© enregistr√©e avec succ√®s")

# --- Sous-traitement ---
def ajouter_sous_traitement(page, st):
    print(f"‚û°Ô∏è Ajout en cours (Sous-traitement) : {st['denomination_fr']} / {st['denomination_ar']}")
    page.get_by_role("button", name="Ajouter").first.click()
    page.wait_for_timeout(1000)
    modal = page.locator("div.v-overlay-container").last
    denom_fr = modal.locator("input").nth(0); denom_fr.wait_for(state="visible", timeout=5000); denom_fr.fill(st["denomination_fr"])
    print(f"‚úÖ D√©nomination FR remplie : {st['denomination_fr']}")
    denom_ar = modal.locator("input").nth(1); denom_ar.wait_for(state="visible", timeout=5000); denom_ar.fill(st["denomination_ar"])
    print(f"‚úÖ D√©nomination AR remplie : {st['denomination_ar']}")
    type_input = modal.locator("label:has-text('Type de traitement') + div input").first
    type_input.click()
    page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    for t in st["types"]:
        page.locator("div.v-overlay-container .v-list-item-title", has_text=t).first.click()
        print(f"‚úÖ Type s√©lectionn√© : {t}")
    page.keyboard.press("Escape")
    select_dropdown(page, "Base l√©gale", st["base_legale"])
    if st.get("sous_traitant"): select_dropdown(page, "Sous traitant", st["sous_traitant"])
    if st.get("logiciel"): select_dropdown(page, "Logiciel utilis√©", st["logiciel"])
    modal.locator("textarea").last.fill(st["note"])
    print("‚úÖ Note remplie")
    modal.locator("button:has-text('Enregistrer')").last.click()
    page.wait_for_timeout(1500)
    print("‚úÖ Sous-traitement ajout√© avec succ√®s")

# --- Conservation des donn√©es ---
def ajouter_conservation_donnees(page, conservation):
    print("‚û°Ô∏è Ajout en cours (Conservation des donn√©es)")
    onglet = page.get_by_text("Conservation des donn√©es", exact=True)
    onglet.scroll_into_view_if_needed(); onglet.click(force=True)
    page.wait_for_load_state("networkidle"); page.wait_for_timeout(400)
    def fill_by_label(label_text: str, value: str):
        lab = page.locator(f"label:has-text('{label_text}')").first
        lab.wait_for(state="visible", timeout=10000)
        inp = lab.locator("xpath=..").locator("input, textarea").first
        inp.wait_for(state="visible", timeout=10000)
        inp.fill(value)
    def ensure_checked(name_substring: str):
        cb = page.get_by_role("checkbox", name=name_substring, exact=False).first
        cb.wait_for(state="visible", timeout=10000)
        try:
            if not cb.is_checked(): cb.check(force=True)
        except Exception: cb.click(force=True)
    if "Manuel" in conservation["modes"]: ensure_checked("Manuel"); print("‚òëÔ∏è Manuel coch√©")
    if "Informatique" in conservation["modes"]: ensure_checked("Informatique"); print("‚òëÔ∏è Informatique coch√©")
    if "informatique" in conservation:
        page.wait_for_selector("label:has-text('Nom de la base de donn√©es')", timeout=10000)
        fill_by_label("Nom de la base de donn√©es", conservation["informatique"]["nom"])
        fill_by_label("Lieu de stockage de la base de donn√©es", conservation["informatique"]["lieu"])
        print("‚úÖ Conservation informatique remplie")
    if "manuel" in conservation:
        page.wait_for_selector("label:has-text('Nom du fichier manuel')", timeout=10000)
        fill_by_label("Nom du fichier manuel", conservation["manuel"]["nom"])
        fill_by_label("Lieu de stockage du fichier", conservation["manuel"]["lieu"])
        print("‚úÖ Conservation manuelle remplie")
    save_current_section(page, label="Conservation des donn√©es")
    print("‚úÖ Conservation des donn√©es enregistr√©e avec succ√®s")

# === DESTINATAIRES ============================================================
def modal_select_dropdown(modal, label, value):
    input_box = modal.locator(f"label:has-text('{label}') + div input[placeholder]").first
    input_box.click()
    modal.page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    modal.page.locator("div.v-overlay-container .v-list-item-title", has_text=value).first.click()
    print(f"‚úÖ {label} s√©lectionn√© : {value}")

def modal_fill(modal, label, value):
    field = modal.locator(f"label:has-text('{label}')").locator("xpath=..").locator("textarea, input").first
    field.fill(str(value))

def ajouter_un_destinataire(page, d):
    page.get_by_role("button", name="Ajouter").first.click()
    page.wait_for_timeout(400)
    modal = page.locator("div.v-overlay-container").last
    dest_input = modal.locator("label:has-text('Destinataire') + div input").first
    dest_input.click()
    if d.get("destinataire"):
        dest_input.fill(d["destinataire"]); modal.page.wait_for_timeout(300)
    modal.page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    modal.page.locator("div.v-overlay-container .v-list-item-title", has_text=d["destinataire"]).first.click()
    print(f"‚úÖ Destinataire s√©lectionn√© : {d['destinataire']}")
    if d.get("moyen"): modal_select_dropdown(modal, "Moyen de communication", d["moyen"])
    if d.get("cadre_legal") is not None: modal_select_dropdown(modal, "Cadre legal", "Oui" if d["cadre_legal"] else "Non")
    if d.get("objectifs"): modal_fill(modal, "Objectifs", d["objectifs"])
    if d.get("observation"): modal_fill(modal, "Observation", d["observation"])
    modal.locator("button:has-text('Enregistrer')").last.click()
    page.wait_for_timeout(800)
    print("üíæ Destinataire ajout√©")

def ajouter_destinataires(page, items):
    print("‚û°Ô∏è Section Destinataires : ajout en cours")
    onglet = page.get_by_text("Les destinataires des donn√©es", exact=True)
    onglet.scroll_into_view_if_needed(); onglet.click(force=True)
    page.wait_for_timeout(800)
    for d in items:
        ajouter_un_destinataire(page, d)
    save_current_section(page, label="Destinataires")
    print("‚úÖ Tous les destinataires ont √©t√© enregistr√©s")

# --- Consentement ---
def ajouter_consentement(page, consent):
    print("‚û°Ô∏è Ajout en cours (Consentement)")
    onglet = page.get_by_text("Consentement", exact=True)
    onglet.scroll_into_view_if_needed(); onglet.click(force=True)
    page.wait_for_timeout(800)
    select_dropdown(page, "Consentement des personnes concern√©es : Existe ?", "Oui" if consent.get("existe", True) else "Non")
    ta_fr = page.locator("label:has-text('Indiquer la m√©thode de consentement')").locator("xpath=..").locator("textarea").first
    if not ta_fr.count(): ta_fr = page.locator("textarea").first
    ta_fr.fill(consent.get("methode_fr", ""))
    ta_ar = page.locator("label:has-text('ÿ≠ÿØÿØ ŸÉŸäŸÅŸäÿ© ÿ£ÿÆÿ∞ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿßŸÑÿµÿ±Ÿäÿ≠ÿ©')").locator("xpath=..").locator("textarea").first
    if not ta_ar.count():
        ta_ar = page.locator("textarea").nth(1) if page.locator("textarea").count() > 1 else None
    if ta_ar: ta_ar.fill(consent.get("methode_ar", ""))
    save_current_section(page, label="Consentement")
    print("‚úÖ Consentement enregistr√©")

# ===================== DROITS DES PERSONNES ‚Äî FR/AR ======================
def fill_pair_ids(page, panel, fr_id: str, fr_val: str, ar_id: str | None, ar_val: str | None):
    fr_val = fr_val or ""
    ar_val = ar_val if ar_val is not None else fr_val
    fr_nodes = _scope(panel, page, f'textarea#{fr_id}, input#{fr_id}')
    if fr_nodes.count():
        print(f"   üìù FR -> #{fr_id}")
        for i in range(fr_nodes.count()):
            safe_fill_input(fr_nodes.nth(i), fr_val)
    else:
        print(f"   ‚ö†Ô∏è FR introuvable: #{fr_id}")
    if ar_id:
        ar_nodes = _scope(panel, page, f'textarea#{ar_id}, input#{ar_id}')
        if ar_nodes.count():
            print(f"   üìù AR -> #{ar_id}")
            for i in range(ar_nodes.count()):
                safe_fill_input(ar_nodes.nth(i), ar_val)
        else:
            print(f"   ‚ö†Ô∏è AR introuvable: #{ar_id}")

def fill_bilingual_same_id(page, panel, base_id: str, fr_val: str, ar_val: str | None):
    fr_val = fr_val or ""
    ar_val = ar_val if ar_val is not None else fr_val
    nodes = _scope(panel, page, f'textarea#{base_id}, input#{base_id}')
    cnt = nodes.count()
    if cnt >= 2:
        print(f"   üìù FR/AR -> #{base_id} (doublon x{cnt})")
        safe_fill_input(nodes.nth(0), fr_val)
        safe_fill_input(nodes.nth(1), ar_val)
    elif cnt == 1:
        print(f"   üìù FR -> #{base_id} (unique)")
        safe_fill_input(nodes.first, fr_val if fr_val else ar_val)
    else:
        print(f"   ‚ö†Ô∏è Champ introuvable: #{base_id}")

def click_onglet_vuetify(page, titre: str, expect_prefix: str | None = None):
    def variants(t):
        return list(dict.fromkeys([t, t.replace("'", "‚Äô"), t.replace("‚Äô", "'")]))
    tablist = page.locator('[role="tablist"]').first
    if tablist.count():
        next_btn = tablist.locator('.v-slide-group__next')
        prev_btn = tablist.locator('.v-slide-group__prev')
        for _ in range(12):
            for cand in variants(titre):
                tab = tablist.get_by_role("tab", name=cand, exact=False).first
                if tab.count():
                    try: tab.scroll_into_view_if_needed()
                    except Exception: pass
                    tab.click(force=True)
                    page.wait_for_load_state("networkidle")
                    page.wait_for_timeout(300)
                    if expect_prefix:
                        panel = get_active_panel(page) or page
                        try:
                            (panel if hasattr(panel, "locator") else page).locator(f'[id^="{expect_prefix}_"]').first.wait_for(timeout=1500)
                        except Exception:
                            pass
                    return
            if next_btn.count() and next_btn.is_enabled():
                try: next_btn.click(); page.wait_for_timeout(200)
                except Exception: break
            else: break
        for _ in range(6):
            if prev_btn.count() and prev_btn.is_enabled():
                prev_btn.click(); page.wait_for_timeout(200)
    for cand in variants(titre):
        t = page.get_by_role("tab", name=cand, exact=False).first
        if t.count():
            t.click(force=True); page.wait_for_timeout(300); return
    page.get_by_text(titre.replace("‚Äô", "'"), exact=False).first.click(); page.wait_for_timeout(300)

def remplir_droits_personnes(page, dp):
    print("‚û°Ô∏è Remplissage de la section Droits des personnes")
    menu = page.get_by_text("Droit des personnes", exact=False)
    menu.scroll_into_view_if_needed(); menu.click(force=True)
    page.wait_for_load_state("networkidle"); page.wait_for_timeout(400)

    # ---- Onglet 1 : Droit √† l'information ----
    if dp.get("information"):
        click_onglet_vuetify(page, "Droit √† l'information", expect_prefix="information_right")
        panel = get_active_panel(page)
        info = dp["information"]; svc = info.get("service", {})

        fill_pair_ids(page, panel, "information_right_how", info.get("comment", ""), "information_right_how_ar", info.get("comment_ar"))
        fill_bilingual_same_id(page, panel, "information_right_mesures_prise", info.get("mesures", ""), info.get("mesures_ar"))
        ar_m = _scope(panel, page, "#information_right_mesures_prise_ar")
        if ar_m.count(): safe_fill_input(ar_m.first, info.get("mesures_ar", info.get("mesures", "")))
        # service FR/AR
        fill_bilingual_same_id(page, panel, "information_right_service_name", svc.get("nom", ""), svc.get("nom_ar"))
        fill_pair_ids(page, panel, "information_right_service_name", svc.get("nom", ""), "information_right_service_name_ar", svc.get("nom_ar"))
        # contacts
        mob = _scope(panel, page, "#information_right_phone")
        if mob.count(): safe_fill_input(mob.first, svc.get("mobile", ""))
        email = _scope(panel, page, "#information_right_email")
        if email.count(): safe_fill_input(email.first, svc.get("email", ""))
        # adresses
        addr_fr = _scope(panel, page, "#information_right_address")
        if addr_fr.count(): safe_fill_input(addr_fr.first, svc.get("adresse", ""))
        else:
            alt_fr = _scope(panel, page, 'input[placeholder*="Adresse"]').first
            if alt_fr.count(): safe_fill_input(alt_fr, svc.get("adresse", ""))
        addr_ar = _scope(panel, page, "#information_right_address_ar")
        if addr_ar.count(): safe_fill_input(addr_ar.first, svc.get("adresse_ar", svc.get("adresse", "")))
        # justification (si pr√©sente)
        if svc.get("justification"):
            try: _scope(panel, page, "fieldset textarea").first.fill(svc["justification"])
            except Exception:
                try:
                    lab = _scope(panel, page, 'label:has-text("Justification")').first
                    lab.locator("xpath=..").locator("textarea, input").first.fill(svc["justification"])
                except Exception: pass

        # ‚úÖ ENREGISTRER AVANT DE PASSER AU 2e ONGLET
        save_current_section(page, panel, label="Droit √† l'information")
        print("‚úÖ Onglet 'Droit √† l'information' enregistr√©")

    # ---- Fonctions de fallback libell√©/placeholder (inchang√©es) ----
    def fill_area_by_label_in(panel, label_txt, value):
        if not value: return
        lab = _scope(panel, page, f'label:has-text("{label_txt}")').first
        if lab.count():
            area = lab.locator("xpath=..").locator("textarea, input").first
            safe_fill_input(area, value)

    def fill_service_block_generic(panel, service):
        try:
            if service.get("nom"):
                _scope(panel, page, 'input[placeholder*="nom du service"]').first.fill(service["nom"])
        except Exception: pass
        try:
            if service.get("justification"):
                _scope(panel, page, "fieldset textarea").first.fill(service["justification"])
        except Exception: pass
        try:
            if service.get("mobile"):
                _scope(panel, page, 'input[placeholder*="Mobile"]').first.fill(service["mobile"])
        except Exception: pass
        try:
            if service.get("email"):
                _scope(panel, page, 'input[placeholder*="E-mail"]').first.fill(service["email"])
        except Exception: pass
        try:
            if service.get("adresse"):
                _scope(panel, page, 'input[placeholder*="Adresse"]').first.fill(service["adresse"])
        except Exception: pass

    def traiter_autre_onglet(titre, data):
        prefix_map = {
            "Droit d'acc√®s": "access_right",
            "Droit √† la rectification": "rectification_right",
            "Droit d'opposition": "opposition_right",
        }
        pref = prefix_map.get(titre)
        click_onglet_vuetify(page, titre, expect_prefix=pref or "")
        panel = get_active_panel(page)

        if pref:
            fill_pair_ids(page, panel, f"{pref}_how", data.get("comment", ""), f"{pref}_how_ar", data.get("comment_ar"))
            fill_bilingual_same_id(page, panel, f"{pref}_mesures_prise", data.get("mesures", ""), data.get("mesures_ar"))
            ar_node = _scope(panel, page, f"#{pref}_mesures_prise_ar")
            if ar_node.count():
                safe_fill_input(ar_node.first, data.get("mesures_ar", data.get("mesures", "")))

        # Fallback libell√©s/placeholder
        fill_area_by_label_in(panel, "Comment les personnes sont-elles inform√©es", data.get("comment", ""))
        fill_area_by_label_in(panel, "Quelles sont les mesures prises pour faciliter l'exercice", data.get("mesures", ""))
        fill_service_block_generic(panel, data.get("service", {}))

        save_current_section(page, panel, label=titre)
        print(f"‚úÖ Onglet '{titre}' enregistr√©")

    # ---- Onglets 2 ‚Üí 4 ----
    if dp.get("acces"): traiter_autre_onglet("Droit d'acc√®s", dp["acces"])
    if dp.get("rectification"): traiter_autre_onglet("Droit √† la rectification", dp["rectification"])
    if dp.get("opposition"): traiter_autre_onglet("Droit d'opposition", dp["opposition"])

    print("‚úÖ Section Droits des personnes compl√©t√©e")

# =================== FIN DROITS (reste du script inchang√©) ===================

# --- Script principal ---
with sync_playwright() as p:
    browser = p.chromium.launch(headless=False)
    page = browser.new_page()

    # Login
    page.goto("https://admin.dp-manager.com/login")
    page.fill("input[placeholder=\"Nom d'utilisateur\"]", "admin")
    page.fill("input[type='password']", "Chtitha@58206670")
    page.click("button:has-text(\"S'authentifier\")")
    page.wait_for_url("**/tenants", timeout=20000)
    print("‚úÖ Connexion r√©ussie (page tenants)")

    # Cr√©ation traitement
    page.goto("https://admin.dp-manager.com/registers/trt-registers/create")
    page.wait_for_url("**/registers/trt-registers/create", timeout=20000)
    print("‚úÖ Page cr√©ation ouverte")

    page.fill("#code", "TRT-TEST1")
    page.fill("#name", "Test Ressources Humaines")
    page.fill("#name_ar", "ÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©")

    page.click("#status")
    page.click("text=En cours")

    page.click("label:has-text(\"Type de traitement\") + div")
    page.locator("div.v-overlay-container div.v-list-item-title", has_text="Manuel").first.click()
    page.locator("div.v-overlay-container div.v-list-item-title", has_text="Automatique").first.click()
    page.click("body")

    save_button = page.locator("button[type='submit']")
    page.wait_for_selector("button[type='submit']:not([disabled])", timeout=5000)
    save_button.click()

    # Fondement l√©gal
    page.click("text=Fondement l√©gal d'un traitement")
    page.fill("textarea", "Loi n¬∞ 08-07, Ordonnance n¬∞ 05-07, D√©cret ex√©cutif n¬∞ 04-90, D√©cret ex√©cutif n¬∞ 23-130, D√©cret n¬∞ 22-208")
    page.locator("textarea").nth(1).fill("ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿ±ŸÇŸÖ 08-07ÿå ÿßŸÑÿ£ŸÖÿ± ÿ±ŸÇŸÖ 05-07ÿå ÿßŸÑŸÖÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿä ÿ±ŸÇŸÖ 04-90ÿå ÿßŸÑŸÖÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿä ÿ±ŸÇŸÖ 23-130ÿå ÿßŸÑŸÖÿ±ÿ≥ŸàŸÖ ÿ±ŸÇŸÖ 22-208")
    page.click("label:has-text('Le consentement expr√®s de la personne concern√©e')")
    page.click("label:has-text(\"L'ex√©cution d'un contrat ou pr√©contrat √† la demande de la personne\")")
    page.locator("textarea").nth(2).fill("Exemple : protection des int√©r√™ts l√©gitimes de l‚Äôorganisation")
    save_current_section(page, label="Fondement l√©gal")
    print("‚úÖ Section Fondement l√©gal enregistr√©e")

    # Cat√©gories de personnes
    menu_item = page.locator("text=Cat√©gories de donn√©es √† caract√®re personnel")
    menu_item.scroll_into_view_if_needed()
    menu_item.click(force=True)
    page.wait_for_timeout(2000)

    categories_personnes = ["Adh√©rant", "Salari√©s"]
    type_collecte = "Manuel et Automatique"
    mode_collecte = "Internet"

    for categorie_personne in categories_personnes:
        page.get_by_role("button", name="Ajouter").click()
        page.wait_for_timeout(1000)
        select_dropdown(page, "Cat√©gorie des personnes concern√©es", categorie_personne)
        select_dropdown(page, "Type de collecte de donn√©es", type_collecte)
        select_dropdown(page, "Mode de collecte", mode_collecte)
        for securite in ["Tra√ßabilit√©", "Signature √©lectronique", "Chiffrement", "Charte de s√©curit√©"]:
            try:
                checkbox = page.locator(f"label:has-text('{securite}')")
                if checkbox.is_visible():
                    checkbox.click()
                    print(f"‚òëÔ∏è {securite} coch√©e")
            except: pass
        save_current_section(page, label=f"Cat√©gorie {categorie_personne}")
        page.wait_for_timeout(1500)

    print("‚úÖ Toutes les cat√©gories de personnes ont √©t√© ajout√©es avec succ√®s")

    # Cat√©gories de donn√©es
    onglet_donnees = page.get_by_text("Cat√©gorie des donn√©es collect√©es et trait√©es", exact=True)
    onglet_donnees.scroll_into_view_if_needed()
    onglet_donnees.click(force=True)
    page.wait_for_timeout(1500)

    categories_donnees = [
        {"categorie_index": 0, "type": "Nom et Pr√©nom", "origine": "Personne concern√©es", "utilise": "Oui", "source": "Dossiers papiers", "duree_type": "Limit√©e", "duree": 120, "declencheur": "A partir de la fin du contrat"},
        {"categorie_index": 0, "type": "Date de Naissance", "origine": "Personne concern√©es", "utilise": "Oui", "source": "Dossiers papiers", "duree_type": "Limit√©e", "duree": 120, "declencheur": "A partir de la fin du contrat"}
    ]
    for donnee in categories_donnees:
        ajouter_categorie_donnees(page, donnee)
    print("‚úÖ Toutes les cat√©gories de donn√©es ont √©t√© ajout√©es avec succ√®s")

    # Finalit√©
    remplir_finalite(
        page,
        "Gestion administrative et p√©dagogique des enseignants et formateurs dans le cadre des activit√©s de l‚Äô√©tablissement de formation",
        "ÿßŸÑÿ™ÿ≥ŸäŸäÿ± ÿßŸÑÿ•ÿØÿßÿ±Ÿä ŸàÿßŸÑÿ®ŸäÿØÿßÿ∫Ÿàÿ¨Ÿä ŸÑŸÑŸÖÿπŸÑŸÖŸäŸÜ ŸàÿßŸÑŸÖŸÉŸàŸÜŸäŸÜ ŸÅŸä ÿ•ÿ∑ÿßÿ± ŸÜÿ¥ÿßÿ∑ÿßÿ™ ŸÖÿ§ÿ≥ÿ≥ÿ© ÿßŸÑÿ™ŸÉŸàŸäŸÜ"
    )

    # Sous-traitements
    onglet_sous_traitements = page.get_by_text("Sous-traitements", exact=True)
    onglet_sous_traitements.scroll_into_view_if_needed(); onglet_sous_traitements.click(force=True)
    page.wait_for_timeout(1500)
    sous_traitements = [
        {"denomination_fr": "Paie externalis√©e","denomination_ar": "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ÿ¨Ÿàÿ±","types": ["Manuel","Automatique"],"base_legale": "Le respect d'une obligation l√©gale.","sous_traitant": "Comptable externe","logiciel": "Novoreka","note": "Gestion de la paie via prestataire externe"},
        {"denomination_fr": "Audit externe","denomination_ar": "ŸÖÿ±ÿßÿ¨ÿπÿ© ÿÆÿßÿ±ÿ¨Ÿäÿ©","types": ["Automatique"],"base_legale": "L'ex√©cution d'une mission d'int√©r√™t public.","sous_traitant": "Auditeur externe","logiciel": "","note": "Audit annuel obligatoire"}
    ]
    for st in sous_traitements:
        ajouter_sous_traitement(page, st)
    print("‚úÖ Tous les sous-traitements ont √©t√© ajout√©s avec succ√®s")

    # Conservation des donn√©es
    ajouter_conservation_donnees(page, {
        "modes": ["Manuel", "Informatique"],
        "informatique": {"nom": "Fichier des enseignants et formateurs","lieu": "Serveur au si√®ge de l'√©cole (Alg√©rie)"},
        "manuel": {"nom": "Dossiers des enseignants et formateurs","lieu": "Salle d'archive au si√®ge de l'√©cole (Alg√©rie)"}
    })

    # Destinataires
    destinataires = [
        {"destinataire": "CNAS","moyen": "Connexion","cadre_legal": True,"objectifs": "D√©clarations sociales et v√©rifications.","observation": "Transmission mensuelle via portail."},
        {"destinataire": "Inspection de travail","moyen": "Papier","cadre_legal": True,"objectifs": "Contr√¥le r√©glementaire.","observation": "Envoi sur demande."}
    ]
    ajouter_destinataires(page, destinataires)

    ajouter_consentement(page, {
        "existe": True,
        "methode_fr": "Consentement explicite √©crit collect√© via formulaire sign√© (papier ou signature √©lectronique).",
        "methode_ar": "ŸÖŸàÿßŸÅŸÇÿ© ÿµÿ±Ÿäÿ≠ÿ© ŸÖŸÉÿ™Ÿàÿ®ÿ© Ÿäÿ™ŸÖ ÿ¨ŸÖÿπŸáÿß ÿπÿ®ÿ± ÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© ŸÖŸÖÿ∂ÿßÿ© (Ÿàÿ±ŸÇŸäÿ© ÿ£Ÿà ÿ™ŸàŸÇŸäÿπ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä)."
    })

   # Droits des personnes (FR + AR)
    remplir_droits_personnes(page, {
    "information": {
        "comment": "Affichage sur le site et note d‚Äôinformation remise lors de l‚Äôinscription.",
        "comment_ar": "ÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ ŸàŸÖÿ∞ŸÉÿ±ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™Ÿèÿ≥ŸÑŸëŸéŸÖ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ.",
        "mesures": "Proc√©dures internes + contact d√©di√© au sein du service juridique.",
        "mesures_ar": "ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿØÿßÿÆŸÑŸäÿ© + ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ ŸÖÿÆÿµÿµÿ© ÿ∂ŸÖŸÜ ÿßŸÑŸÖÿµŸÑÿ≠ÿ© ÿßŸÑŸÇÿßŸÜŸàŸÜŸäÿ©.",
        "service": {
            "nom": "Service Juridique", "nom_ar": "ÿßŸÑŸÖÿµŸÑÿ≠ÿ© ÿßŸÑŸÇÿßŸÜŸàŸÜŸäÿ©",
            "justification": "Point de contact pour toute demande relative √† l'information.",
            "mobile": "0550123456", "email": "juridique@ecole.dz",
            "adresse": "Si√®ge de l'√©cole ‚Äì Alger", "adresse_ar": "ŸÖŸÇÿ± ÿßŸÑŸÖÿØÿ±ÿ≥ÿ© ‚Äì ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±"
        }
    },
    "acces": {
        "comment": "Formulaire de demande en ligne + accueil physique.", "comment_ar": "ÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© ÿ∑ŸÑÿ® ÿπÿ®ÿ± ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ + ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ≠ÿ∂Ÿàÿ±Ÿä.",
        "mesures": "V√©rification d‚Äôidentit√© et r√©ponse sous 30 jours.", "mesures_ar": "ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸáŸàŸäÿ© ŸàÿßŸÑÿ±ÿØ ÿÆŸÑÿßŸÑ 30 ŸäŸàŸÖŸãÿß.",
        "service": {
            "nom": "Service Archives", "nom_ar": "ŸÖÿµŸÑÿ≠ÿ© ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ",
            "mobile": "0551223344", "email": "archives@ecole.dz",
            "adresse": "Bureau des archives ‚Äì Alger", "adresse_ar": "ŸÖŸÉÿ™ÿ® ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ‚Äì ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±"
        }
    },
    "rectification": {
        "comment": "Demande via e-mail ou guichet administratif.", "comment_ar": "ÿ∑ŸÑÿ® ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ£Ÿà ÿßŸÑÿ¥ÿ®ÿßŸÉ ÿßŸÑÿ•ÿØÿßÿ±Ÿä.",
        "mesures": "Proc√©dure de correction dans 72 h.", "mesures_ar": "ÿ•ÿ¨ÿ±ÿßÿ° ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠ ÿÆŸÑÿßŸÑ 72 ÿ≥ÿßÿπÿ©.",
        "service": {
            "nom": "Service Scolarit√©", "nom_ar": "ŸÖÿµŸÑÿ≠ÿ© ÿßŸÑÿ™ŸÖÿØÿ±ÿ≥",
            "mobile": "0552667788", "email": "scolarite@ecole.dz",
            "adresse": "Rez-de-chauss√©e, b√¢timent A", "adresse_ar": "ÿßŸÑÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ£ÿ±ÿ∂Ÿäÿå ÿßŸÑŸÖÿ®ŸÜŸâ A"
        }
    },
    "opposition": {
        "comment": "Formulaire d‚Äôopposition disponible sur le site.", "comment_ar": "ÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© ÿßÿπÿ™ÿ±ÿßÿ∂ ŸÖÿ™ÿßÿ≠ÿ© ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ.",
        "mesures": "Analyse de recevabilit√© et d√©sactivation des traitements concern√©s.", "mesures_ar": "ÿ™ÿ≠ŸÑŸäŸÑ ŸÇÿßÿ®ŸÑŸäÿ© ÿßŸÑŸÇÿ®ŸàŸÑ Ÿàÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿßŸÑŸÖÿπŸÜŸäÿ©.",
        "service": {
            "nom": "DPO / Protection des donn√©es", "nom_ar": "ŸÖÿ≥ÿ§ŸàŸÑ ÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
            "mobile": "0553998877", "email": "dpo@ecole.dz",
            "adresse": "Direction ‚Äì 2e √©tage", "adresse_ar": "ÿßŸÑŸÖÿØŸäÿ±Ÿäÿ© ‚Äì ÿßŸÑÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ´ÿßŸÜŸä"
        }
    }
})
