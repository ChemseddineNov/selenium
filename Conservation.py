from playwright.sync_api import sync_playwright

# --- Helpers g√©n√©riques corrig√©s ---
def select_dropdown(page, label, value):
    # cibler uniquement l'input visible (celui qui a un placeholder)
    input_box = page.locator(f"label:has-text('{label}') + div input[placeholder]").first
    input_box.click()
    page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    page.locator("div.v-overlay-container .v-list-item-title", has_text=value).first.click()
    print(f"‚úÖ {label} s√©lectionn√© : {value}")

def fill_input(page, label, value):
    page.wait_for_selector(f"label:has-text('{label}')")
    input_box = page.locator(f"label:has-text('{label}')").locator("xpath=..").locator("input")
    input_box.fill(str(value))
    print(f"‚úÖ {label} rempli : {value}")


# --- Ajout cat√©gorie de donn√©es ---
def ajouter_categorie_donnees(page, donnee):
    print(f"‚û°Ô∏è Ajout en cours (Cat√©gorie de donn√©es) : {donnee['categorie_index']} - {donnee['type']}")

    page.get_by_role("button", name="Ajouter").first.click()
    page.wait_for_timeout(1000)

    # Cat√©gorie
    page.locator("label:has-text('Cat√©gorie des donn√©es') + div input").click()
    page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    page.locator("div.v-overlay-container .v-list-item-title").nth(donnee["categorie_index"]).click()
    print(f"‚úÖ Cat√©gorie s√©lectionn√©e (index {donnee['categorie_index']})")

    select_dropdown(page, "Type des donn√©es", donnee["type"])
    select_dropdown(page, "Origine de la donn√©e", donnee["origine"])
    select_dropdown(page, "Utilis√©(s) pour la finalit√© du traitement", donnee["utilise"])
    select_dropdown(page, "Source de donn√©es", donnee["source"])

    if donnee["duree_type"] != "Limit√©e":
        select_dropdown(page, "Dur√©e de conservation", donnee["duree_type"])
    else:
        print("‚ÑπÔ∏è Dur√©e de conservation par d√©faut = Limit√©e (aucune action n√©cessaire)")

    fill_input(page, "Pr√©ciser la dur√©e (mois)", donnee["duree"])
    fill_input(page, "√âl√©ment d√©clencheur", donnee["declencheur"])

    page.locator("button:has-text('Enregistrer')").last.click()
    page.wait_for_timeout(1500)
    print(f"‚úÖ Cat√©gorie de donn√©es ajout√©e avec succ√®s")


# --- Remplir Finalit√© ---
def remplir_finalite(page, finalite_fr, finalite_ar):
    print("‚û°Ô∏è Remplissage de la section Finalit√©")

    menu_item = page.get_by_text("Finalit√©", exact=True)
    menu_item.scroll_into_view_if_needed()
    menu_item.click(force=True)
    page.wait_for_timeout(1500)

    textarea_fr = page.locator("label:has-text('Finalit√© (but) du traitement')").locator("xpath=..").locator("textarea")
    textarea_fr.fill(finalite_fr)
    print(f"‚úÖ Finalit√© FR remplie : {finalite_fr}")

    textarea_ar = page.locator("label:has-text('ÿßŸÑÿ∫ÿßŸäÿ© (ÿßŸÑŸáÿØŸÅ) ŸÖŸÜ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©')").locator("xpath=..").locator("textarea")
    textarea_ar.fill(finalite_ar)
    print(f"‚úÖ Finalit√© AR remplie : {finalite_ar}")

    page.locator("button:has-text('Enregistrer')").last.click()
    page.wait_for_timeout(1500)
    print("‚úÖ Section Finalit√© enregistr√©e avec succ√®s")


# --- Ajout Sous-traitement ---
def ajouter_sous_traitement(page, st):
    print(f"‚û°Ô∏è Ajout en cours (Sous-traitement) : {st['denomination_fr']} / {st['denomination_ar']}")

    page.get_by_role("button", name="Ajouter").first.click()
    page.wait_for_timeout(1000)

    modal = page.locator("div.v-overlay-container").last

    # --- Champ FR ---
    denom_fr = modal.locator("input").nth(0)
    denom_fr.wait_for(state="visible", timeout=5000)
    denom_fr.fill(st["denomination_fr"])
    print(f"‚úÖ D√©nomination FR remplie : {st['denomination_fr']}")

    # --- Champ AR ---
    denom_ar = modal.locator("input").nth(1)
    denom_ar.wait_for(state="visible", timeout=5000)
    denom_ar.fill(st["denomination_ar"])
    print(f"‚úÖ D√©nomination AR remplie : {st['denomination_ar']}")

    # --- Type de traitement (multi-select) ---
    type_input = modal.locator("label:has-text('Type de traitement') + div input").first
    type_input.click()
    page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")

    for t in st["types"]:
        option = page.locator("div.v-overlay-container .v-list-item-title", has_text=t).first
        option.click()
        print(f"‚úÖ Type s√©lectionn√© : {t}")

    page.keyboard.press("Escape")  # ferme le menu apr√®s toutes les s√©lections

    # --- Base l√©gale ---
    select_dropdown(page, "Base l√©gale", st["base_legale"])

    # --- Sous-traitant ---
    if st.get("sous_traitant"):
        select_dropdown(page, "Sous traitant", st["sous_traitant"])

    # --- Logiciel ---
    if st.get("logiciel"):
        select_dropdown(page, "Logiciel utilis√©", st["logiciel"])

    # --- Note ---
    modal.locator("textarea").last.fill(st["note"])
    print("‚úÖ Note remplie")

    # --- Enregistrer ---
    modal.locator("button:has-text('Enregistrer')").last.click()
    page.wait_for_timeout(1500)
    print("‚úÖ Sous-traitement ajout√© avec succ√®s")


# --- Conservation des donn√©es (robuste) ---
def ajouter_conservation_donnees(page, conservation):
    print("‚û°Ô∏è Ajout en cours (Conservation des donn√©es)")

    # Aller dans l'onglet
    onglet = page.get_by_text("Conservation des donn√©es", exact=True)
    onglet.scroll_into_view_if_needed()
    onglet.click(force=True)

    # laisser la vue se stabiliser
    page.wait_for_load_state("networkidle")
    page.wait_for_timeout(400)

    # Helper local pour remplir par label
    def fill_by_label(label_text: str, value: str):
        lab = page.locator(f"label:has-text('{label_text}')").first
        lab.wait_for(state="visible", timeout=10000)
        inp = lab.locator("xpath=..").locator("input, textarea").first
        inp.wait_for(state="visible", timeout=10000)
        inp.fill(value)

    # Cocher via r√¥le aria (plus robuste que le :has-text bilingue)
    def ensure_checked(name_substring: str):
        cb = page.get_by_role("checkbox", name=name_substring, exact=False).first
        cb.wait_for(state="visible", timeout=10000)
        try:
            if not cb.is_checked():
                cb.check(force=True)
        except Exception:
            cb.click(force=True)

    # Coche les modes demand√©s
    if "Manuel" in conservation["modes"]:
        ensure_checked("Manuel")
        print("‚òëÔ∏è Manuel coch√©")

    if "Informatique" in conservation["modes"]:
        ensure_checked("Informatique")
        print("‚òëÔ∏è Informatique coch√©")

    # Remplissage des blocs
    if "informatique" in conservation:
        page.wait_for_selector("label:has-text('Nom de la base de donn√©es')", timeout=10000)
        fill_by_label("Nom de la base de donn√©es", conservation["informatique"]["nom"])
        fill_by_label("Lieu de stockage de la base de donn√©es", conservation["informatique"]["lieu"])
        print("‚úÖ Conservation informatique remplie")

    if "manuel" in conservation:
        page.wait_for_selector("label:has-text('Nom du fichier manuel')", timeout=10000)
        fill_by_label("Nom du fichier manuel", conservation["manuel"]["nom"])
        fill_by_label("Lieu de stockage du fichier", conservation["manuel"]["lieu"])
        print("‚úÖ Conservation manuelle remplie")

    # Enregistrer
    save_btn = page.locator("button:has-text('Enregistrer')").last
    save_btn.scroll_into_view_if_needed()
    save_btn.click(force=True)
    page.wait_for_timeout(1000)
    print("‚úÖ Conservation des donn√©es enregistr√©e avec succ√®s")


# === DESTINATAIRES ============================================================
# Helpers port√©s sur la modale
def modal_select_dropdown(modal, label, value):
    input_box = modal.locator(f"label:has-text('{label}') + div input[placeholder]").first
    input_box.click()
    modal.page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    modal.page.locator("div.v-overlay-container .v-list-item-title", has_text=value).first.click()
    print(f"‚úÖ {label} s√©lectionn√© : {value}")

def modal_fill(modal, label, value):
    field = modal.locator(f"label:has-text('{label}')").locator("xpath=..").locator("textarea, input").first
    field.fill(str(value))

def ajouter_un_destinataire(page, d):
    # Ouvrir la modale
    page.get_by_role("button", name="Ajouter").first.click()
    page.wait_for_timeout(400)
    modal = page.locator("div.v-overlay-container").last

    # Destinataire (lookup)
    dest_input = modal.locator("label:has-text('Destinataire') + div input").first
    dest_input.click()
    if d.get("destinataire"):
        dest_input.fill(d["destinataire"])
        modal.page.wait_for_timeout(300)
    modal.page.wait_for_selector("div.v-overlay-container .v-list-item-title", state="visible")
    modal.page.locator("div.v-overlay-container .v-list-item-title", has_text=d["destinataire"]).first.click()
    print(f"‚úÖ Destinataire s√©lectionn√© : {d['destinataire']}")

    # Moyen de communication
    if d.get("moyen"):
        modal_select_dropdown(modal, "Moyen de communication", d["moyen"])

    # Cadre legal (Oui/Non)
    if d.get("cadre_legal") is not None:
        modal_select_dropdown(modal, "Cadre legal", "Oui" if d["cadre_legal"] else "Non")

    # Objectifs / Observation
    if d.get("objectifs"):
        modal_fill(modal, "Objectifs", d["objectifs"])
    if d.get("observation"):
        modal_fill(modal, "Observation", d["observation"])

    # Enregistrer
    modal.locator("button:has-text('Enregistrer')").last.click()
    page.wait_for_timeout(800)
    print("üíæ Destinataire ajout√©")

def ajouter_destinataires(page, items):
    print("‚û°Ô∏è Section Destinataires : ajout en cours")
    onglet = page.get_by_text("Les destinataires des donn√©es", exact=True)
    onglet.scroll_into_view_if_needed()
    onglet.click(force=True)
    page.wait_for_timeout(800)

    for d in items:
        ajouter_un_destinataire(page, d)

    # Enregistrer la section
    save = page.locator("button:has-text('Enregistrer')").last
    save.scroll_into_view_if_needed()
    save.click()
    page.wait_for_timeout(1200)
    print("‚úÖ Tous les destinataires ont √©t√© enregistr√©s")
# ============================================================================
# --- Consentement ---
def ajouter_consentement(page, consent):
    """
    consent = {
        "existe": True/False,
        "methode_fr": "‚Ä¶",
        "methode_ar": "‚Ä¶"
    }
    """
    print("‚û°Ô∏è Ajout en cours (Consentement)")

    # Ouvrir l'onglet
    onglet = page.get_by_text("Consentement", exact=True)
    onglet.scroll_into_view_if_needed()
    onglet.click(force=True)
    page.wait_for_timeout(800)

    # Oui / Non
    select_dropdown(
        page,
        "Consentement des personnes concern√©es : Existe ?",
        "Oui" if consent.get("existe", True) else "Non",
    )

    # Textarea FR (libell√© FR ou fallback premier textarea)
    ta_fr = page.locator("label:has-text('Indiquer la m√©thode de consentement')").locator("xpath=..").locator("textarea").first
    if not ta_fr.count():
        ta_fr = page.locator("textarea").first
    ta_fr.fill(consent.get("methode_fr", ""))

    # Textarea AR (libell√© AR ou fallback deuxi√®me textarea s‚Äôil existe)
    ta_ar = page.locator("label:has-text('ÿ≠ÿØÿØ ŸÉŸäŸÅŸäÿ© ÿ£ÿÆÿ∞ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿßŸÑÿµÿ±Ÿäÿ≠ÿ©')").locator("xpath=..").locator("textarea").first
    if not ta_ar.count():
        # s'il n'y a qu'une seule zone, on ne fait rien ; s'il y en a 2, on prend la seconde
        if page.locator("textarea").count() > 1:
            ta_ar = page.locator("textarea").nth(1)
        else:
            ta_ar = None
    if ta_ar:
        ta_ar.fill(consent.get("methode_ar", ""))

    # Enregistrer
    page.locator("button:has-text('Enregistrer')").last.click()
    page.wait_for_timeout(800)
    print("‚úÖ Consentement enregistr√©")
    
    # --- DROITS DES PERSONNES ----------------------------------------------------
def remplir_droits_personnes(page, dp):
    print("‚û°Ô∏è Remplissage de la section Droits des personnes")

    # Aller √† la section
    menu = page.get_by_text("Droit des personnes", exact=False)
    menu.scroll_into_view_if_needed()
    menu.click(force=True)
    page.wait_for_timeout(800)

    # Helpers
    def click_onglet(nom):
        try:
            tab = page.get_by_role("tab", name=nom, exact=False).first
            tab.wait_for(state="visible", timeout=5000)
            tab.click(force=True)
        except Exception:
            page.get_by_text(nom, exact=False).first.click()
        page.wait_for_timeout(400)

    def fill_area_by_label(label_txt, value):
        if not value:
            return
        # ‚ö†Ô∏è utiliser des guillemets doubles dans has-text pour √©viter le conflit avec l'apostrophe
        lab = page.locator(f'label:has-text("{label_txt}")').first
        lab.wait_for(state="visible", timeout=8000)
        area = lab.locator("xpath=..").locator("textarea, input").first
        area.wait_for(state="visible", timeout=8000)
        area.fill(value)

    def fill_service_block(service):
        if service.get("nom"):
            page.get_by_placeholder("Le nom du service aupr√®s duquel la personne concern√©e").first.fill(service["nom"])
        if service.get("justification"):
            # 1er textarea du bloc service (fallback si structure varie)
            zone = page.locator("fieldset textarea").first
            zone.fill(service["justification"])
        if service.get("mobile"):
            page.get_by_placeholder("Mobile").first.fill(service["mobile"])
        if service.get("email"):
            page.get_by_placeholder("E-mail").first.fill(service["email"])
        if service.get("adresse"):
            page.get_by_placeholder("Adresse").first.fill(service["adresse"])

    def traiter_un_onglet(titre, data):
        click_onglet(titre)
        fill_area_by_label("Comment les personnes sont-elles inform√©es", data.get("comment", ""))
        # Cette √©tiquette contient l'apostrophe ‚Üí guillemets doubles indispensables
        fill_area_by_label("Quelles sont les mesures prises pour faciliter l'exercice", data.get("mesures", ""))
        fill_service_block(data.get("service", {}))
        save_btn = page.locator("button:has-text('Enregistrer')").last
        save_btn.scroll_into_view_if_needed()
        save_btn.click(force=True)
        page.wait_for_timeout(600)
        print(f"‚úÖ Onglet '{titre}' enregistr√©")

    if dp.get("information"):
        traiter_un_onglet("Droit √† l'information", dp["information"])
    if dp.get("acces"):
        traiter_un_onglet("Droit d'acc√®s", dp["acces"])
    if dp.get("rectification"):
        traiter_un_onglet("Droit √† la rectification", dp["rectification"])
    if dp.get("opposition"):
        traiter_un_onglet("Droit d'opposition", dp["opposition"])

    print("‚úÖ Section Droits des personnes compl√©t√©e")




# --- Script principal ---
with sync_playwright() as p:
    browser = p.chromium.launch(headless=False)
    page = browser.new_page()

    # Login
    page.goto("https://admin.dp-manager.com/login")
    page.fill("input[placeholder=\"Nom d'utilisateur\"]", "admin")
    page.fill("input[type='password']", "Chtitha@58206670")
    page.click("button:has-text(\"S'authentifier\")")
    page.wait_for_url("**/tenants", timeout=20000)
    print("‚úÖ Connexion r√©ussie (page tenants)")

    # Cr√©ation traitement
    page.goto("https://admin.dp-manager.com/registers/trt-registers/create")
    page.wait_for_url("**/registers/trt-registers/create", timeout=20000)
    print("‚úÖ Page cr√©ation ouverte")

    page.fill("#code", "TRT-TEST")
    page.fill("#name", "Test Ressources Humaines")
    page.fill("#name_ar", "ÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©")

    page.click("#status")
    page.click("text=En cours")

    page.click("label:has-text(\"Type de traitement\") + div")
    page.locator("div.v-overlay-container div.v-list-item-title", has_text="Manuel").first.click()
    page.locator("div.v-overlay-container div.v-list-item-title", has_text="Automatique").first.click()
    page.click("body")

    save_button = page.locator("button[type='submit']")
    page.wait_for_selector("button[type='submit']:not([disabled])", timeout=5000)
    save_button.click()

    
    remplir_droits_personnes(page, {
    "information": {
        "comment": "Affichage sur le site et note d‚Äôinformation remise lors de l‚Äôinscription.",
        "comment_ar": "ÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ ŸàŸÖÿ∞ŸÉÿ±ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™Ÿèÿ≥ŸÑŸëŸéŸÖ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ.",
        "mesures": "Proc√©dures internes + contact d√©di√© au sein du service juridique.",
        "mesures_ar": "ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿØÿßÿÆŸÑŸäÿ© + ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ ŸÖÿÆÿµÿµÿ© ÿ∂ŸÖŸÜ ÿßŸÑŸÖÿµŸÑÿ≠ÿ© ÿßŸÑŸÇÿßŸÜŸàŸÜŸäÿ©.",
        "service": {
            "nom": "Service Juridique",
            "nom_ar": "ÿßŸÑŸÖÿµŸÑÿ≠ÿ© ÿßŸÑŸÇÿßŸÜŸàŸÜŸäÿ©",
            "justification": "Point de contact pour toute demande relative √† l'information.",
            # "justification_ar": "ŸÜŸÇÿ∑ÿ© ÿßÿ™ÿµÿßŸÑ ŸÑÿ£Ÿä ÿ∑ŸÑÿ® ŸÖÿ™ÿπŸÑŸÇ ÿ®ÿßŸÑŸÖÿπŸÑŸàŸÖÿ©.",  # d√©commente si un champ existe
            "mobile": "0550 12 34 56",
            "mobile_ar": "0550 12 34 56",
            "email": "juridique@ecole.dz",
            "email_ar": "juridique@ecole.dz",
            "adresse": "Si√®ge de l'√©cole ‚Äì Alger",
            "adresse_ar": "ŸÖŸÇÿ± ÿßŸÑŸÖÿØÿ±ÿ≥ÿ© ‚Äì ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±"
        }
    },
    "acces": {
        "comment": "Formulaire de demande en ligne + accueil physique.",
        "comment_ar": "ÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© ÿ∑ŸÑÿ® ÿπÿ®ÿ± ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ + ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ≠ÿ∂Ÿàÿ±Ÿä.",
        "mesures": "V√©rification d‚Äôidentit√© et r√©ponse sous 30 jours.",
        "mesures_ar": "ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸáŸàŸäÿ© ŸàÿßŸÑÿ±ÿØ ÿÆŸÑÿßŸÑ 30 ŸäŸàŸÖŸãÿß.",
        "service": {
            "nom": "Service Archives",
            "nom_ar": "ŸÖÿµŸÑÿ≠ÿ© ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ",
            "mobile": "0551 22 33 44",
            "mobile_ar": "0551 22 33 44",
            "email": "archives@ecole.dz",
            "email_ar": "archives@ecole.dz",
            "adresse": "Bureau des archives ‚Äì Alger",
            "adresse_ar": "ŸÖŸÉÿ™ÿ® ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ‚Äì ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±"
        }
    },
    "rectification": {
        "comment": "Demande via e-mail ou guichet administratif.",
        "comment_ar": "ÿ∑ŸÑÿ® ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ£Ÿà ÿßŸÑÿ¥ÿ®ÿßŸÉ ÿßŸÑÿ•ÿØÿßÿ±Ÿä.",
        "mesures": "Proc√©dure de correction dans 72 h.",
        "mesures_ar": "ÿ•ÿ¨ÿ±ÿßÿ° ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠ ÿÆŸÑÿßŸÑ 72 ÿ≥ÿßÿπÿ©.",
        "service": {
            "nom": "Service Scolarit√©",
            "nom_ar": "ŸÖÿµŸÑÿ≠ÿ© ÿßŸÑÿ™ŸÖÿØÿ±ÿ≥",
            "mobile": "0552 66 77 88",
            "mobile_ar": "0552 66 77 88",
            "email": "scolarite@ecole.dz",
            "email_ar": "scolarite@ecole.dz",
            "adresse": "Rez-de-chauss√©e, b√¢timent A",
            "adresse_ar": "ÿßŸÑÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ£ÿ±ÿ∂Ÿäÿå ÿßŸÑŸÖÿ®ŸÜŸâ A"
        }
    },
    "opposition": {
        "comment": "Formulaire d‚Äôopposition disponible sur le site.",
        "comment_ar": "ÿßÿ≥ÿ™ŸÖÿßÿ±ÿ© ÿßÿπÿ™ÿ±ÿßÿ∂ ŸÖÿ™ÿßÿ≠ÿ© ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ.",
        "mesures": "Analyse de recevabilit√© et d√©sactivation des traitements concern√©s.",
        "mesures_ar": "ÿ™ÿ≠ŸÑŸäŸÑ ŸÇÿßÿ®ŸÑŸäÿ© ÿßŸÑŸÇÿ®ŸàŸÑ Ÿàÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿßŸÑŸÖÿπŸÜŸäÿ©.",
        "service": {
            "nom": "DPO / Protection des donn√©es",
            "nom_ar": "ŸÖÿ≥ÿ§ŸàŸÑ ÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
            "mobile": "0553 99 88 77",
            "mobile_ar": "0553 99 88 77",
            "email": "dpo@ecole.dz",
            "email_ar": "dpo@ecole.dz",
            "adresse": "Direction ‚Äì 2e √©tage",
            "adresse_ar": "ÿßŸÑŸÖÿØŸäÿ±Ÿäÿ© ‚Äì ÿßŸÑÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ´ÿßŸÜŸä"
        }
    }
})



